<style>
img{
    width: 50%;
    padding-left: 20%;
}
</style>

### 第 9 章 道高一尺 - 上传组件

- 9-1 上传组件需求分析
- 9-2 上传文件的两种实现方式
- 9-3
- 9-4 Uploader 组件第二部分
- 9-5 Uploader 组件第三部分：自定义模版
- [[9-6 改进路由验证系统]]
- 9-7 创建文章页面实现 Uploader 自定义样式
- 9-8 大功告成 创建文章最后流程
- 9-9 作业 完成文章详情页

### 上传原理

- 参考资料
  - [Using XMLHttpRequest 发送表单、上传文件 - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest#submitting_forms_and_uploading_files)
  - 何时使用 [html - What does enctype='multipart/form-data' mean? - Stack Overflow](https://stackoverflow.com/a/28380690/10915537)
    - `multipart/form-data`: 上传文件时使用
    - `application/x-www-form-urlencoded`: 除上传文件外使用
    - `text/plain`: 基本不使用
    - 切换到 example 文件夹下，命令行中输入 `nc -kdl localhost 8000` 搭建 echo server，查看三者的请求体。只有 `multipart/form-data` 成功发送了文件，其他只发送了文件名
      - `multipart/form-data`
        - ![](attachments/mlutpart发送请求.png)
      - `application/x-www-form-urlencoded`
        - ```text
          text1=text+default&text2=a%CF%89b&file1=a.html&file2=a.txt&file3=
          ```
      - `text/plain`
        - ```text
          text1=text default
          text2=aωb
          file1=a.html
          file2=a.txt
          file3=
          ```
  - 注意
    - `<form action="http://localhost:8000" method="post" enctype="text/plain">`，表单中的 enctype 相当于请求头中的 content-type
  - 关键 API
    - [FormData.append() - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/FormData/append)

### ajax 上传文件流程

- `change` 事件在 input type 不同时，触发的时机不同，当 type = file 时，`change` 事件会在选择上传文件时触发，此时可以监听 `change` 事件，并获取该文件

```mermaid
sequenceDiagram
participant b as broswer
participant a as ajax
participant s as server
autonumber
b->>b:选择文件，触发 change 事件
b->>a:1. 监听 change 事件<br> 2. 获取到被选择的文件，验证文件格式、大小等信息<br>3. 添加到新建的 formData 对象上<br>FormData.append(file)
a->>s:设置请求头<br>Content-Type:multipart/form-data<br>发送请求<br>axios.post(url, FormData)
a->>b:显示正在上传提示信息
alt 成功
  s->>a:返回图片链接
  a->>b:显示上传成功信息，展示上传图片缩略图
else 失败
  s->>a:返回错误信息
  a->>b:显示上传失败信息
end
a->>b:清除准备上传的文件
```

### 创建文章跳转流程

```mermaid
sequenceDiagram
participant b as broswer
participant a as vuex
participant s as server
autonumber
b->>a:监听 onPostSubmit
a->>s:发送请求 /api/posts，创建文章
s->>a:响应(此时已经返回了完整的文章数据)，获取响应内容中文章 id
a->>a:将文章数填充入 store 中
a->>a:computed 检测到 store 中数据变化
a->>b:渲染页面
```

#### 重构 store 中 post 数据结构

为什么要重构？上图第 4 步中需要将数据添加至 post 中，但是 post 的数据结构为：

```javascript
[
  {
    _id: "xxxx1",
    content: "xxxx"
  }
];
```

每次添加文章，都需要利用文章 id 遍历匹配。计划重构为：

```javascript
{
  _id: {
    _id:"xxxx1",
    content: "xxxx"
  }
}
```

重构后，直接 `post.push(新建文章)` 即可

### 心得

- 靠，傻了吧唧的认证搞半天。上传文件时请求体为 formData，需要使用 FormData.append 把认证码加进去

[//begin]: # "Autogenerated link references for markdown compatibility"
[9-6 改进路由验证系统]: 9-6 改进路由验证系统 "9-6 改进路由验证系统"
[//end]: # "Autogenerated link references"
