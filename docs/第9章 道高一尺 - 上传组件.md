### 第9章 道高一尺 - 上传组件
- 9-1 上传组件需求分析
  - 上传组件
    - 组件位置：新建文章视图
    - 抽象需求
      - 整体流程
      - ```mermaid
          graph TD
            1(上传前)-->2(上传中)
            2-->3(上传后)
            2-->4(上传失败后)
        ``` 
      - 上传前: 对图片相关参数进行校验
      - 上传中: 显示上传进度或者上传提示信息，发送 uploading 事件
      - 上传后: 显示上传图片缩略图，发送 fileUploaded 事件
      - 上传失败后: 显示上传失败信息，发送 uploadedError 事件
    - 组件参数
      - props
        - action: 目标 URL
        - beforeUpload: 自定义的校验函数
      - emits
        - 监听不同事件创建提示信息
        - uploading
        - fileUploaded
        - uploadedError
      - slots
      - attrs
    - 组件样式
      - 上传前
        - 点击上传按钮选择文件上传
      - 上传中
        - loading 状态 + 提示信息
      - 上传后
        - 上传图片缩略图
- 9-2 上传文件的两种实现方式
- 9-3
- 9-4 Uploader 组件第二部分
- 9-5 Uploader 组件第三部分：自定义模版
- [[9-6 改进路由验证系统]]
- 9-7 创建文章页面实现 Uploader 自定义样式
- 9-8 大功告成 创建文章最后流程
- 9-9 作业 完成文章详情页

### 上传原理
- 参考资料
  - [Using XMLHttpRequest 发送表单、上传文件 - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest#submitting_forms_and_uploading_files)
  - 何时使用 [html - What does enctype='multipart/form-data' mean? - Stack Overflow](https://stackoverflow.com/a/28380690/10915537)
    - `multipart/form-data`: 上传文件时使用
    - `application/x-www-form-urlencoded`: 除上传文件外使用
    - `text/plain`: 基本不使用
    - 切换到 example 文件夹下，命令行中输入 `nc -kdl localhost 8000` 搭建 echo server，查看三者的请求体。只有 `multipart/form-data` 成功发送了文件，其他只发送了文件名
      - `multipart/form-data`
        - ![](attachments/mlutpart发送请求.png)
      - `application/x-www-form-urlencoded`
        - ```text
          text1=text+default&text2=a%CF%89b&file1=a.html&file2=a.txt&file3=
          ```  
      - `text/plain`
        - ```text
          text1=text default
          text2=aωb
          file1=a.html
          file2=a.txt
          file3=
          ```  
  - 注意
    - `<form action="http://localhost:8000" method="post" enctype="text/plain">`，表单中的 enctype 相当于请求头中的 content-type
  - 关键 API
    - [FormData.append() - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/FormData/append)
### ajax 上传文件流程
- `change` 事件在 input type 不同时，触发的时机不同，当 type = file 时，`change` 事件会在选择上传文件时触发，此时可以监听 `change` 事件，并获取该文件
```mermaid
sequenceDiagram
participant b as broswer
participant a as ajax
participant s as server
autonumber
b->>b:选择文件，触发 change 事件
b->>a:1. 监听 change 事件<br> 2. 获取到被选择的文件，验证文件格式、大小等信息<br>3. 添加到新建的 formData 对象上<br>FormData.append(file)
a->>s:设置请求头<br>Content-Type:multipart/form-data<br>发送请求<br>axios.post(url, FormData)
a->>b:显示正在上传提示信息
alt 成功
  s->>a:返回图片链接
  a->>b:显示上传成功信息，展示上传图片缩略图
else 失败
  s->>a:返回错误信息
  a->>b:显示上传失败信息
end
a->>b:清除准备上传的文件
```
### 心得
- 靠，傻了吧唧的认证搞半天。上传文件时请求体为 formData，需要使用 FormData.append 把认证码加进去